#!/usr/bin/env bash

if [[ $# -ne 1 ]]; then
  echo "Usage: $0 DRAFT_FILE"
  exit 1
fi

draft_file="$1"

srcdir="$(dirname $0)/../src"

post_file="$srcdir/_posts/$(date '+%Y-%m-%d')-$(basename "$draft_file")"

echo "Moving $draft_file => $post_file"
mv "$draft_file" "$post_file"
if [[ $? -ne 0 ]]; then exit 1; fi

echo "Staging..."
git add "$srcdir"
if [[ $? -ne 0 ]]; then exit 1; fi
git status

post_slug="$(basename ${draft_file%.*})"

echo "Committing..."
git commit -m "Publish $post_slug"
if [[ $? -ne 0 ]]; then exit 1; fi

echo "Pushing..."
git push
if [[ $? -ne 0 ]]; then exit 1; fi

post_url="https://blog.djy.io/$post_slug/"

echo "Waiting for post to go live at: $post_url"
while true; do
  if curl --fail "$post_url" > /dev/null 2>&1; then
    echo "Post is live."
    break
  fi
done
